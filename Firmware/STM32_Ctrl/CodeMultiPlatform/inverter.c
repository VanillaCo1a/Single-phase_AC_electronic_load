#include "inverter.h"

#define lenof(ARRAY) (sizeof(ARRAY) / sizeof(*ARRAY))
const static uint16_t sinnum[] = {
    28, 85, 141, 198, 254, 311, 367, 423, 479, 535,
    591, 647, 702, 758, 813, 868, 923, 977, 1031, 1086,
    1139, 1193, 1246, 1299, 1351, 1404, 1456, 1507, 1558, 1609,
    1660, 1709, 1759, 1808, 1857, 1905, 1953, 2000, 2047, 2093,
    2139, 2184, 2229, 2273, 2316, 2359, 2402, 2444, 2485, 2526,
    2565, 2605, 2644, 2682, 2719, 2756, 2792, 2827, 2862, 2896,
    2929, 2962, 2993, 3024, 3055, 3084, 3113, 3141, 3168, 3195,
    3220, 3245, 3269, 3293, 3315, 3337, 3358, 3377, 3397, 3415,
    3432, 3449, 3465, 3480, 3494, 3507, 3519, 3531, 3541, 3551,
    3560, 3568, 3575, 3581, 3587, 3591, 3595, 3597, 3599, 3600,
    3600, 3599, 3597, 3595, 3591, 3587, 3581, 3575, 3568, 3560,
    3551, 3541, 3531, 3519, 3507, 3494, 3480, 3465, 3449, 3432,
    3415, 3397, 3377, 3358, 3337, 3315, 3293, 3269, 3245, 3220,
    3195, 3168, 3141, 3113, 3084, 3055, 3024, 2993, 2962, 2929,
    2896, 2862, 2827, 2792, 2756, 2719, 2682, 2644, 2605, 2565,
    2526, 2485, 2444, 2402, 2359, 2316, 2273, 2229, 2184, 2139,
    2093, 2047, 2000, 1953, 1905, 1857, 1808, 1759, 1709, 1660,
    1609, 1558, 1507, 1456, 1404, 1351, 1299, 1246, 1193, 1139,
    1086, 1031, 977, 923, 868, 813, 758, 702, 647, 591,
    535, 479, 423, 367, 311, 254, 198, 141, 85, 28,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

#define ARR_MAX 3600

uint16_t inverterNum = 0;
/* 两路pwm的相位偏差和最大幅值 */
uint16_t position, amplitude;

void INVERTER_Init(void) {
    position = 50;
    amplitude = 80;
    __HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_1, ARR_MAX / 2);
    __HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_4, ARR_MAX / 2);
    HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
    HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_4);
    HAL_TIM_Base_Start_IT(&htim1);
}

void INVERTER_Callback(void *handle) {
    if(handle == &htim1) {
        inverterNum = inverterNum + 1 == lenof(sinnum) ? 0 : inverterNum + 1;
        __HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_1,
                             sinnum[inverterNum] * 80 / 100);
        __HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_4,
                             sinnum[(inverterNum + lenof(sinnum) * position / 100) % lenof(sinnum)] * 80 / 100);
    }
}
